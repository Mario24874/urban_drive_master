<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Urban Drive - App Completa</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    
    <!-- Mapbox -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Tu diseño original */
        .bg-urban {
            background-image: url('./public/assets/background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .btn-primary {
            background-color: #000000;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #374151;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-urban min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Configuración Firebase con tus credenciales reales
        const firebaseConfig = {
            apiKey: "AIzaSyD_zQMqs8o3evjEtjkuXybPW-sdH4c573M",
            authDomain: "urbandrive-1082b.firebaseapp.com",
            projectId: "urbandrive-1082b",
            storageBucket: "urbandrive-1082b.appspot.com",
            messagingSenderId: "470229432792",
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Configurar Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoibWFyaW9tb3Jlbm8yNDg3NCIsImEiOiJjbTFqbHd4OXowcGVjMmxweGZ4cTAzbnU2In0.qcWbkzqpr0Qir9dcjqUewg';

        // Iconos SVG
        const Home = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
        );

        const MapPin = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
        );

        const MessageSquare = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
        );

        const User = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        );

        const LogIn = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="m15 3 4 4-4 4"/>
                <path d="M2 12h14"/>
            </svg>
        );

        const UserPlus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <line x1="19" x2="19" y1="8" y2="14"/>
                <line x1="22" x2="16" y1="11" y2="11"/>
            </svg>
        );

        const LogOut = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="m9 21-4-4 4-4"/>
                <path d="M20 12H7"/>
            </svg>
        );

        const Phone = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
            </svg>
        );

        const Users = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="m22 21-3.5-3.5"/>
                <circle cx="18.5" cy="13.5" r="2.5"/>
            </svg>
        );

        const Eye = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );

        const EyeOff = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="m15.5 4.5-2.5 2.5m-7 7 2.5 2.5"/>
                <path d="m9.9 4.3 5.8 5.8"/>
                <path d="M1 12s4-8 11-8c1.1 0 2.2.2 3.2.5"/>
                <path d="m17 17-2.5-2.5"/>
                <path d="M23 12s-4 8-11 8c-1.1 0-2.2-.2-3.2-.5"/>
            </svg>
        );

        const Edit = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M7 7H5a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2"/>
                <path d="M16 3l4 4L9 18l-4 1 1-4z"/>
            </svg>
        );

        const Building = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <rect width="16" height="20" x="4" y="2" rx="2" ry="2"/>
                <path d="M8 6h.01"/>
                <path d="M16 6h.01"/>
                <path d="M12 6h.01"/>
                <path d="M12 10h.01"/>
                <path d="M12 14h.01"/>
                <path d="M16 10h.01"/>
                <path d="M16 14h.01"/>
                <path d="M8 10h.01"/>
                <path d="M8 14h.01"/>
            </svg>
        );

        const UserCircle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="10" r="3"/>
                <path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
            </svg>
        );

        const Share = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                <polyline points="16,6 12,2 8,6"/>
                <line x1="12" x2="12" y1="2" y2="15"/>
            </svg>
        );

        const QrCode = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <rect width="5" height="5" x="3" y="3" rx="1"/>
                <rect width="5" height="5" x="16" y="3" rx="1"/>
                <rect width="5" height="5" x="3" y="16" rx="1"/>
                <path d="m21 16-3.5-3.5-1 1"/>
                <path d="m21 21-3.5-3.5-1 1"/>
            </svg>
        );

        const Link = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
        );

        const Bell = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
        );

        // Componente principal
        const UrbanDriveApp = () => {
            const [currentPage, setCurrentPage] = useState('home');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [isVisible, setIsVisible] = useState(true);
            const [editingProfile, setEditingProfile] = useState(false);
            const [operationMode, setOperationMode] = useState('personal'); // 'personal' o 'business'
            const [userLocation, setUserLocation] = useState(null);
            const [locationError, setLocationError] = useState(null);
            
            // Estado de autenticación
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    if (user) {
                        setUser({
                            id: user.uid,
                            email: user.email,
                            displayName: user.displayName || user.email
                        });
                        if (currentPage === 'login' || currentPage === 'register') {
                            setCurrentPage('dashboard');
                        }
                    } else {
                        setUser(null);
                    }
                });
                
                return () => unsubscribe();
            }, [currentPage]);

            // Sistema de Geolocalización
            const getLocation = async () => {
                setLocationError(null);
                
                // Opción 1: HTML5 Geolocation (GPS/WiFi)
                if (navigator.geolocation) {
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutos
                    };
                    
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const location = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                method: 'GPS/WiFi',
                                timestamp: new Date().toISOString()
                            };
                            
                            setUserLocation(location);
                            
                            // Guardar ubicación en Firebase
                            if (user) {
                                try {
                                    // Intentar actualizar, si falla crear el documento
                                    await db.collection('users').doc(user.id).set({
                                        location: location,
                                        lastLocationUpdate: firebase.firestore.FieldValue.serverTimestamp()
                                    }, { merge: true });
                                } catch (error) {
                                    console.error('Error guardando ubicación:', error);
                                }
                            }
                        },
                        async (error) => {
                            console.log('GPS no disponible, usando IP geolocation...');
                            setLocationError(`GPS Error: ${error.message}`);
                            await getLocationByIP();
                        },
                        options
                    );
                } else {
                    console.log('Geolocation no soportado, usando IP...');
                    await getLocationByIP();
                }
            };

            // Opción 2: Geolocalización por IP (respaldo)
            const getLocationByIP = async () => {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    if (data.latitude && data.longitude) {
                        const location = {
                            latitude: data.latitude,
                            longitude: data.longitude,
                            accuracy: 5000, // Menos preciso
                            method: 'IP',
                            city: data.city,
                            country: data.country_name,
                            timestamp: new Date().toISOString()
                        };
                        
                        setUserLocation(location);
                        
                        // Guardar en Firebase
                        if (user) {
                            try {
                                await db.collection('users').doc(user.id).set({
                                    location: location,
                                    lastLocationUpdate: firebase.firestore.FieldValue.serverTimestamp()
                                }, { merge: true });
                            } catch (error) {
                                console.error('Error guardando ubicación IP:', error);
                            }
                        }
                    }
                } catch (error) {
                    setLocationError('No se pudo obtener ubicación');
                    console.error('Error obteniendo ubicación por IP:', error);
                }
            };

            // Ejecutar geolocalización cuando el usuario se loguea
            useEffect(() => {
                if (user && !userLocation) {
                    getLocation();
                }
            }, [user]);

            // Sistema de Invitaciones
            const generateInvitationLink = async () => {
                if (!user) {
                    alert('Debes estar logueado para generar invitaciones');
                    return null;
                }
                
                const invitationId = `inv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                try {
                    // Obtener datos completos del usuario de Firestore
                    let userData = null;
                    try {
                        const userDoc = await db.collection('users').doc(user.id).get();
                        if (userDoc.exists) {
                            userData = userDoc.data();
                        }
                    } catch (firestoreError) {
                        console.log('Sin datos de Firestore, usando datos básicos');
                    }
                    
                    // Intentar guardar invitación en Firebase
                    try {
                        await db.collection('invitations').doc(invitationId).set({
                            inviterId: user.id,
                            inviterName: userData?.displayName || user.displayName || user.email?.split('@')[0] || 'Usuario',
                            inviterEmail: user.email,
                            inviterPhone: userData?.phone || 'No especificado',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            used: false,
                            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 días
                        });
                        console.log('Invitación guardada en Firebase');
                    } catch (firebaseError) {
                        console.log('Error guardando en Firebase, continuando con enlace local:', firebaseError);
                        // Continuar sin Firebase para demo
                    }
                    
                    const baseUrl = window.location.origin + window.location.pathname;
                    const inviteUrl = `${baseUrl}?invite=${invitationId}`;
                    
                    console.log('Invitación generada:', inviteUrl);
                    return inviteUrl;
                } catch (error) {
                    console.error('Error completo generando invitación:', error);
                    alert(`Error: ${error.message || 'No se pudo generar la invitación'}`);
                    return null;
                }
            };

            // Funciones de autenticación
            const handleLogin = async (email, password) => {
                setLoading(true);
                setMessage('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    setMessage('¡Login exitoso!');
                } catch (error) {
                    setMessage(`Error: ${error.message}`);
                }
                setLoading(false);
            };

            const handleRegister = async (email, password, displayName, phone, userType, username) => {
                setLoading(true);
                setMessage('');
                try {
                    const result = await auth.createUserWithEmailAndPassword(email, password);
                    await result.user.updateProfile({ displayName });
                    
                    // Guardar en Firestore con todos los datos
                    await db.collection('users').doc(result.user.uid).set({
                        displayName,
                        username,
                        email,
                        phone,
                        userType,
                        isVisible: true,
                        isActive: userType === 'driver' ? false : true,
                        contacts: [],
                        visibleTo: [], // Array de IDs a quienes es visible
                        location: null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setMessage('¡Registro exitoso!');
                } catch (error) {
                    setMessage(`Error: ${error.message}`);
                }
                setLoading(false);
            };

            const handleLogout = () => {
                auth.signOut();
                setCurrentPage('home');
            };

            // Navegación
            const navigation = [
                { id: 'home', label: 'Inicio', icon: Home },
                { id: 'map', label: 'Mapa', icon: MapPin },
                { id: 'contacts', label: 'Contactos', icon: Users },
                { id: 'messages', label: 'Mensajes', icon: MessageSquare },
                { id: 'profile', label: 'Perfil', icon: User },
            ];

            return (
                <div className="min-h-screen bg-black bg-opacity-40 relative">
                    {/* Header */}
                    <header className="bg-white bg-opacity-90 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-40">
                        <div className="max-w-6xl mx-auto px-4">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center space-x-3">
                                    <img src="./public/assets/UrbanDrive.png" alt="Urban Drive" className="w-10 h-10 rounded-lg object-contain" />
                                    <h1 className="text-xl font-bold text-gray-900">Urban Drive</h1>
                                </div>
                                
                                <nav className="flex items-center space-x-4">
                                    {user ? (
                                        <>
                                            {navigation.map(({ id, label, icon: Icon }) => (
                                                <button
                                                    key={id}
                                                    onClick={() => setCurrentPage(id)}
                                                    className={`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                        currentPage === id
                                                            ? 'bg-black text-white'
                                                            : 'text-gray-700 hover:bg-gray-100'
                                                    }`}
                                                >
                                                    <Icon size={18} />
                                                    <span className="hidden sm:inline">{label}</span>
                                                </button>
                                            ))}
                                            <button
                                                onClick={handleLogout}
                                                className="flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 transition-colors"
                                            >
                                                <LogOut size={18} />
                                                <span className="hidden sm:inline">Salir</span>
                                            </button>
                                        </>
                                    ) : (
                                        <>
                                            <button
                                                onClick={() => setCurrentPage('login')}
                                                className={`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                    currentPage === 'login'
                                                        ? 'bg-black text-white'
                                                        : 'text-gray-700 hover:bg-gray-100'
                                                }`}
                                            >
                                                <LogIn size={18} />
                                                <span>Login</span>
                                            </button>
                                            <button
                                                onClick={() => setCurrentPage('register')}
                                                className={`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                    currentPage === 'register'
                                                        ? 'bg-black text-white'
                                                        : 'text-gray-700 hover:bg-gray-100'
                                                }`}
                                            >
                                                <UserPlus size={18} />
                                                <span>Registro</span>
                                            </button>
                                        </>
                                    )}
                                </nav>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-grow flex items-center justify-center p-4">
                        <div className="w-full max-w-md">
                            <div className="card p-6 fade-in">
                                {message && (
                                    <div className={`mb-4 p-3 rounded-lg text-sm ${
                                        message.includes('Error') 
                                            ? 'bg-red-100 text-red-700 border border-red-200'
                                            : 'bg-green-100 text-green-700 border border-green-200'
                                    }`}>
                                        {message}
                                    </div>
                                )}

                                {currentPage === 'home' && <HomePage operationMode={operationMode} setOperationMode={setOperationMode} />}
                                {currentPage === 'login' && <LoginPage onLogin={handleLogin} loading={loading} />}
                                {currentPage === 'register' && <RegisterPage onRegister={handleRegister} loading={loading} />}
                                {currentPage === 'dashboard' && <DashboardPage user={user} isVisible={isVisible} setIsVisible={setIsVisible} userLocation={userLocation} locationError={locationError} getLocation={getLocation} />}
                                {currentPage === 'map' && <MapPage user={user} />}
                                {currentPage === 'contacts' && <ContactsPage user={user} generateInvitationLink={generateInvitationLink} />}
                                {currentPage === 'messages' && <MessagesPage user={user} />}
                                {currentPage === 'profile' && <ProfilePage user={user} editingProfile={editingProfile} setEditingProfile={setEditingProfile} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // Página de inicio
        const HomePage = ({ operationMode, setOperationMode }) => (
            <div className="text-center space-y-6">
                <h1 className="text-3xl font-bold text-gray-900">Bienvenido a Urban Drive</h1>
                <p className="text-gray-600">Tu aplicación de transporte moderna y multiplataforma</p>
                
                <div className="grid gap-4 mt-8">
                    <div className="p-4 border border-gray-200 rounded-lg">
                        <MapPin size={32} className="mx-auto text-black mb-2" />
                        <h3 className="font-semibold text-gray-900">Ubicaciones en Tiempo Real</h3>
                        <p className="text-sm text-gray-600">Encuentra conductores cerca de ti</p>
                    </div>
                    <div className="p-4 border border-gray-200 rounded-lg">
                        <MessageSquare size={32} className="mx-auto text-black mb-2" />
                        <h3 className="font-semibold text-gray-900">Comunicación Directa</h3>
                        <p className="text-sm text-gray-600">Chatea con tus contactos</p>
                    </div>
                </div>
                
                {/* Selector de Modo de Operación */}
                <div className="bg-white border border-gray-200 rounded-lg p-4 mt-6">
                    <h4 className="font-semibold text-gray-900 mb-4">Modo de Operación</h4>
                    <div className="grid grid-cols-1 gap-3">
                        <button
                            onClick={() => setOperationMode('personal')}
                            className={`p-4 border rounded-lg text-left transition-all ${
                                operationMode === 'personal'
                                    ? 'bg-blue-50 border-blue-300 text-blue-900'
                                    : 'bg-white border-gray-300 text-gray-700 hover:border-gray-400'
                            }`}
                        >
                            <div className="flex items-center space-x-3">
                                <UserCircle size={24} className={operationMode === 'personal' ? 'text-blue-600' : 'text-gray-500'} />
                                <div className="flex-1">
                                    <h5 className="font-semibold">Personal</h5>
                                    <p className="text-sm opacity-80">
                                        Contacta conductores particulares para viajes personales
                                    </p>
                                </div>
                                {operationMode === 'personal' && (
                                    <div className="w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center">
                                        <div className="w-2 h-2 bg-white rounded-full"></div>
                                    </div>
                                )}
                            </div>
                        </button>
                        
                        <button
                            onClick={() => setOperationMode('business')}
                            className={`p-4 border rounded-lg text-left transition-all ${
                                operationMode === 'business'
                                    ? 'bg-purple-50 border-purple-300 text-purple-900'
                                    : 'bg-white border-gray-300 text-gray-700 hover:border-gray-400'
                            }`}
                        >
                            <div className="flex items-center space-x-3">
                                <Building size={24} className={operationMode === 'business' ? 'text-purple-600' : 'text-gray-500'} />
                                <div className="flex-1">
                                    <h5 className="font-semibold">Empresarial</h5>
                                    <p className="text-sm opacity-80">
                                        Gestiona flotas de vehículos con control avanzado
                                    </p>
                                    {operationMode === 'business' && (
                                        <div className="mt-2 space-y-1 text-xs">
                                            <p>• 📍 Registro de ubicaciones</p>
                                            <p>• ⚡ Control de velocidad</p>
                                            <p>• ⏱️ Tiempos de trayectoria</p>
                                            <p>• 📊 Reportes avanzados</p>
                                        </div>
                                    )}
                                </div>
                                {operationMode === 'business' && (
                                    <div className="w-4 h-4 bg-purple-600 rounded-full flex items-center justify-center">
                                        <div className="w-2 h-2 bg-white rounded-full"></div>
                                    </div>
                                )}
                            </div>
                        </button>
                    </div>
                    
                    {operationMode === 'business' && (
                        <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                            <p className="text-sm text-amber-800">
                                💼 <strong>Modo Empresarial:</strong> Funciones premium disponibles próximamente
                            </p>
                        </div>
                    )}
                </div>
            </div>
        );

        // Página de login
        const LoginPage = ({ onLogin, loading }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(email, password);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h2 className="text-2xl font-bold text-gray-900 text-center">Iniciar Sesión</h2>
                    
                    <div>
                        <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                            Email
                        </label>
                        <input
                            id="email"
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                            required
                        />
                    </div>
                    
                    <div>
                        <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
                            Contraseña
                        </label>
                        <input
                            id="password"
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                            required
                        />
                    </div>
                    
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full btn-primary flex items-center justify-center"
                    >
                        {loading ? (
                            <>
                                <span className="spinner mr-2"></span>
                                Iniciando sesión...
                            </>
                        ) : (
                            'Iniciar Sesión'
                        )}
                    </button>
                </form>
            );
        };

        // Página de registro
        const RegisterPage = ({ onRegister, loading }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [displayName, setDisplayName] = useState('');
            const [phone, setPhone] = useState('');
            const [userType, setUserType] = useState('user');
            const [username, setUsername] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onRegister(email, password, displayName, phone, userType, username);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h2 className="text-2xl font-bold text-gray-900 text-center">Crear Cuenta</h2>
                    
                    <div>
                        <label htmlFor="displayName" className="block text-sm font-medium text-gray-700 mb-1">
                            Nombre Completo
                        </label>
                        <input
                            id="displayName"
                            type="text"
                            value={displayName}
                            onChange={(e) => setDisplayName(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                            required
                        />
                    </div>
                    
                    <div>
                        <label htmlFor="username" className="block text-sm font-medium text-gray-700 mb-1">
                            Nombre de Usuario
                        </label>
                        <input
                            id="username"
                            type="text"
                            value={username}
                            onChange={(e) => setUsername(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                            placeholder="@usuario123"
                            required
                        />
                    </div>
                    
                    <div>
                        <label htmlFor="phone" className="block text-sm font-medium text-gray-700 mb-1">
                            <Phone size={16} className="inline mr-1" />
                            Número de Teléfono
                        </label>
                        <input
                            id="phone"
                            type="tel"
                            value={phone}
                            onChange={(e) => setPhone(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                            placeholder="+1234567890"
                            required
                        />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Tipo de Usuario
                        </label>
                        <div className="grid grid-cols-2 gap-3">
                            <button
                                type="button"
                                onClick={() => setUserType('user')}
                                className={`p-3 border rounded-lg text-center transition-all ${
                                    userType === 'user' 
                                        ? 'bg-black text-white border-black' 
                                        : 'bg-white text-gray-700 border-gray-300 hover:border-gray-400'
                                }`}
                            >
                                <User size={20} className="mx-auto mb-1" />
                                <span className="text-sm font-medium">Usuario</span>
                            </button>
                            <button
                                type="button"
                                onClick={() => setUserType('driver')}
                                className={`p-3 border rounded-lg text-center transition-all ${
                                    userType === 'driver' 
                                        ? 'bg-black text-white border-black' 
                                        : 'bg-white text-gray-700 border-gray-300 hover:border-gray-400'
                                }`}
                            >
                                <MapPin size={20} className="mx-auto mb-1" />
                                <span className="text-sm font-medium">Conductor</span>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                            Email
                        </label>
                        <input
                            id="email"
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                            required
                        />
                    </div>
                    
                    <div>
                        <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
                            Contraseña
                        </label>
                        <input
                            id="password"
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                            required
                            minLength="6"
                        />
                    </div>
                    
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full btn-primary flex items-center justify-center"
                    >
                        {loading ? (
                            <>
                                <span className="spinner mr-2"></span>
                                Creando cuenta...
                            </>
                        ) : (
                            'Crear Cuenta'
                        )}
                    </button>
                </form>
            );
        };

        // Dashboard
        const DashboardPage = ({ user, isVisible, setIsVisible, userLocation, locationError, getLocation }) => {
            const toggleVisibility = async () => {
                try {
                    await db.collection('users').doc(user.id).update({
                        isVisible: !isVisible,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setIsVisible(!isVisible);
                } catch (error) {
                    console.error('Error actualizando visibilidad:', error);
                }
            };

            return (
                <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-gray-900">¡Bienvenido!</h2>
                    
                    {/* Switch de Visibilidad */}
                    <div className="bg-white border border-gray-200 p-4 rounded-lg">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                {isVisible ? <Eye size={20} className="text-green-600" /> : <EyeOff size={20} className="text-red-600" />}
                                <span className="font-medium text-gray-900">
                                    Estado: {isVisible ? 'Visible' : 'Invisible'}
                                </span>
                            </div>
                            <button
                                onClick={toggleVisibility}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                                    isVisible ? 'bg-green-600' : 'bg-gray-300'
                                }`}
                            >
                                <span
                                    className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                        isVisible ? 'translate-x-6' : 'translate-x-1'
                                    }`}
                                />
                            </button>
                        </div>
                        <p className="text-sm text-gray-600 mt-2">
                            {isVisible 
                                ? 'Tus contactos pueden verte en el mapa' 
                                : 'Estás oculto para todos tus contactos'
                            }
                        </p>
                    </div>

                    {/* Información de Ubicación */}
                    <div className="bg-white border border-gray-200 p-4 rounded-lg">
                        <div className="flex items-center justify-between mb-3">
                            <h4 className="font-semibold text-gray-900">📍 Tu Ubicación</h4>
                            <button
                                onClick={getLocation}
                                className="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                Actualizar
                            </button>
                        </div>
                        
                        {userLocation ? (
                            <div className="space-y-2">
                                <div className="flex items-center space-x-2">
                                    <span className={`w-2 h-2 rounded-full ${
                                        userLocation.method === 'GPS/WiFi' ? 'bg-green-500' : 'bg-yellow-500'
                                    }`}></span>
                                    <span className="text-sm font-medium">
                                        {userLocation.method === 'GPS/WiFi' ? 'GPS/WiFi' : 'IP Aproximada'}
                                    </span>
                                    <span className="text-xs text-gray-500">
                                        (±{userLocation.accuracy < 100 ? Math.round(userLocation.accuracy) + 'm' : Math.round(userLocation.accuracy/1000) + 'km'})
                                    </span>
                                </div>
                                
                                <div className="text-xs text-gray-600">
                                    <p>Lat: {userLocation.latitude.toFixed(6)}</p>
                                    <p>Lng: {userLocation.longitude.toFixed(6)}</p>
                                    {userLocation.city && <p>📍 {userLocation.city}, {userLocation.country}</p>}
                                    <p>🕒 {new Date(userLocation.timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                        ) : locationError ? (
                            <div className="flex items-center space-x-2 text-red-600">
                                <span className="w-2 h-2 rounded-full bg-red-500"></span>
                                <span className="text-sm">{locationError}</span>
                            </div>
                        ) : (
                            <div className="flex items-center space-x-2 text-gray-600">
                                <span className="w-2 h-2 rounded-full bg-gray-400"></span>
                                <span className="text-sm">Obteniendo ubicación...</span>
                            </div>
                        )}
                    </div>

                    <div className="bg-gray-50 p-4 rounded-lg">
                        <p className="text-gray-700">
                            <strong>Usuario:</strong> {user?.displayName || user?.email}
                        </p>
                        <p className="text-gray-700">
                            <strong>Email:</strong> {user?.email}
                        </p>
                    </div>
                    
                    <div className="grid gap-3">
                        <div className="bg-green-50 border border-green-200 p-4 rounded-lg">
                            <h3 className="font-semibold text-green-800">🎉 ¡Autenticación Exitosa!</h3>
                            <p className="text-sm text-green-700">Firebase está funcionando correctamente</p>
                        </div>
                        
                        <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                            <h3 className="font-semibold text-blue-800">📱 App Multiplataforma</h3>
                            <p className="text-sm text-blue-700">Web • PWA • Android • iOS</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Página de mapa
        const MapPage = () => {
            useEffect(() => {
                const mapContainer = document.getElementById('mapbox-map');
                if (mapContainer && mapContainer.children.length === 0) {
                    const map = new mapboxgl.Map({
                        container: 'mapbox-map',
                        style: 'mapbox://styles/mapbox/streets-v11',
                        center: [-74.006, 40.7128],
                        zoom: 12
                    });

                    // Agregar control de navegación
                    map.addControl(new mapboxgl.NavigationControl());

                    // Agregar marcador
                    new mapboxgl.Marker()
                        .setLngLat([-74.006, 40.7128])
                        .addTo(map);
                }
            }, []);

            return (
                <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-gray-900">Mapa</h2>
                    <div id="mapbox-map" style={{ height: '300px', borderRadius: '8px' }}></div>
                    <div className="bg-green-50 border border-green-200 p-3 rounded-lg">
                        <p className="text-sm text-green-700">
                            ✅ <strong>Mapbox funcionando:</strong> Token configurado correctamente
                        </p>
                    </div>
                </div>
            );
        };

        // Página de contactos
        const ContactsPage = ({ user, generateInvitationLink }) => {
            const [contacts, setContacts] = useState([]);
            const [searchPhone, setSearchPhone] = useState('');
            const [loading, setLoading] = useState(false);
            const [inviteLink, setInviteLink] = useState('');
            const [showQR, setShowQR] = useState(false);

            const searchContact = async () => {
                if (!searchPhone.trim()) return;
                
                setLoading(true);
                try {
                    const result = await db.collection('users')
                        .where('phone', '==', searchPhone.trim())
                        .limit(1)
                        .get();
                    
                    if (!result.empty) {
                        const contactData = { id: result.docs[0].id, ...result.docs[0].data() };
                        
                        // Verificar si ya es contacto
                        if (contacts.find(c => c.id === contactData.id)) {
                            alert('Este usuario ya está en tus contactos');
                            setLoading(false);
                            return;
                        }
                        
                        // Agregar a contactos mutuamente
                        await Promise.all([
                            db.collection('users').doc(user.id).update({
                                contacts: firebase.firestore.FieldValue.arrayUnion(contactData.id)
                            }),
                            db.collection('users').doc(contactData.id).update({
                                contacts: firebase.firestore.FieldValue.arrayUnion(user.id)
                            })
                        ]);
                        
                        setContacts(prev => [...prev, contactData]);
                        setSearchPhone('');
                        alert(`${contactData.displayName} agregado a tus contactos`);
                    } else {
                        alert('Usuario no encontrado. ¿Quieres enviarle una invitación?');
                    }
                } catch (error) {
                    console.error('Error buscando contacto:', error);
                    alert('Error al buscar contacto');
                }
                setLoading(false);
            };

            const createInvitation = async () => {
                setLoading(true);
                try {
                    console.log('Generando invitación...');
                    const link = await generateInvitationLink();
                    console.log('Enlace generado:', link);
                    
                    if (link) {
                        setInviteLink(link);
                        
                        // Copiar al portapapeles
                        try {
                            if (navigator.clipboard) {
                                await navigator.clipboard.writeText(link);
                                alert('¡Enlace de invitación copiado al portapapeles!');
                            } else {
                                alert('Enlace generado. Cópialo manualmente desde la caja de texto.');
                            }
                        } catch (clipboardError) {
                            console.log('Error copiando al portapapeles:', clipboardError);
                            alert('Enlace generado. Cópialo manualmente desde la caja de texto.');
                        }
                    } else {
                        alert('Error generando enlace de invitación. Revisa la consola para más detalles.');
                    }
                } catch (error) {
                    console.error('Error creando invitación:', error);
                    alert(`Error creando invitación: ${error.message}`);
                }
                setLoading(false);
            };

            const shareInvitation = async () => {
                if (!inviteLink) {
                    await createInvitation();
                    return;
                }

                const shareData = {
                    title: 'Únete a Urban Drive',
                    text: `${user.displayName} te invita a usar Urban Drive para ubicación y transporte en tiempo real`,
                    url: inviteLink
                };

                if (navigator.share) {
                    try {
                        await navigator.share(shareData);
                    } catch (error) {
                        console.log('Error compartiendo:', error);
                    }
                } else {
                    // Fallback: copiar al portapapeles
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(inviteLink);
                        alert('Enlace copiado al portapapeles');
                    }
                }
            };

            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-gray-900">Contactos</h2>
                        <button
                            onClick={shareInvitation}
                            disabled={loading}
                            className="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                        >
                            <Share size={18} />
                            <span>Invitar</span>
                        </button>
                    </div>
                    
                    {/* Sección de Invitaciones Rápidas */}
                    {inviteLink && (
                        <div className="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 p-4 rounded-lg">
                            <h3 className="font-semibold text-blue-900 mb-3">🚀 Enlace de Invitación Listo</h3>
                            <div className="bg-white p-3 rounded-lg border mb-3">
                                <p className="text-xs text-gray-600 mb-1">Copia este enlace y envíalo:</p>
                                <div className="flex items-center space-x-2">
                                    <p className="text-xs bg-gray-50 p-2 rounded border break-all flex-1">{inviteLink}</p>
                                    <button
                                        onClick={() => navigator.clipboard.writeText(inviteLink)}
                                        className="px-2 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700"
                                    >
                                        📋
                                    </button>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2">
                                <button
                                    onClick={() => window.open(`https://wa.me/?text=${encodeURIComponent('¡Únete a Urban Drive! ' + inviteLink)}`, '_blank')}
                                    className="flex items-center justify-center space-x-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                >
                                    <span>📱</span>
                                    <span>WhatsApp</span>
                                </button>
                                
                                <button
                                    onClick={() => window.open(`sms:?body=${encodeURIComponent('¡Únete a Urban Drive! ' + inviteLink)}`, '_blank')}
                                    className="flex items-center justify-center space-x-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    <span>💬</span>
                                    <span>SMS</span>
                                </button>
                                
                                <button
                                    onClick={() => window.open(`mailto:?subject=${encodeURIComponent('Invitación Urban Drive')}&body=${encodeURIComponent('¡Únete a Urban Drive! ' + inviteLink)}`, '_blank')}
                                    className="flex items-center justify-center space-x-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                                >
                                    <span>📧</span>
                                    <span>Email</span>
                                </button>
                                
                                <button
                                    onClick={shareInvitation}
                                    className="flex items-center justify-center space-x-2 px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                >
                                    <Share size={16} />
                                    <span>Compartir</span>
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Buscar contacto */}
                    <div className="bg-white border border-gray-200 p-4 rounded-lg">
                        <h3 className="font-semibold text-gray-900 mb-3">Agregar Contacto</h3>
                        <div className="flex space-x-2 mb-3">
                            <input
                                type="tel"
                                value={searchPhone}
                                onChange={(e) => setSearchPhone(e.target.value)}
                                placeholder="Buscar por teléfono..."
                                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                            />
                            <button
                                onClick={searchContact}
                                disabled={loading}
                                className="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50"
                            >
                                {loading ? 'Buscando...' : 'Buscar'}
                            </button>
                        </div>
                        
                        {/* Opciones de Invitación */}
                        <div className="border-t pt-3">
                            <h4 className="text-sm font-medium text-gray-700 mb-2">💌 ¿No está registrado? Invítalo:</h4>
                            <div className="grid grid-cols-1 gap-2">
                                <button
                                    onClick={shareInvitation}
                                    disabled={loading}
                                    className="flex items-center justify-center space-x-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                                >
                                    <Share size={16} />
                                    <span>Enviar Invitación</span>
                                </button>
                                
                                <button
                                    onClick={() => setShowQR(!showQR)}
                                    className="flex items-center justify-center space-x-2 px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                >
                                    <QrCode size={16} />
                                    <span>{showQR ? 'Ocultar' : 'Mostrar'} QR</span>
                                </button>
                                
                                {inviteLink && (
                                    <button
                                        onClick={createInvitation}
                                        disabled={loading}
                                        className="flex items-center justify-center space-x-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50"
                                    >
                                        <Link size={16} />
                                        <span>Nuevo Enlace</span>
                                    </button>
                                )}
                            </div>
                            
                            {inviteLink && (
                                <div className="mt-3 p-3 bg-gray-50 rounded-lg">
                                    <p className="text-xs text-gray-600 mb-1">Enlace de invitación:</p>
                                    <p className="text-xs bg-white p-2 rounded border break-all">{inviteLink}</p>
                                </div>
                            )}
                            
                            {showQR && inviteLink && (
                                <div className="mt-3 p-3 bg-gray-50 rounded-lg text-center">
                                    <p className="text-sm text-gray-600 mb-2">Código QR para escanear:</p>
                                    <div className="w-32 h-32 bg-white border mx-auto flex items-center justify-center">
                                        <QrCode size={48} className="text-gray-400" />
                                        <p className="text-xs text-gray-500 ml-2">QR Code<br/>Próximamente</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Lista de contactos */}
                    <div className="space-y-2">
                        {contacts.length === 0 ? (
                            <div className="bg-gray-50 p-4 rounded-lg text-center">
                                <Users size={48} className="mx-auto text-gray-400 mb-2" />
                                <p className="text-gray-600">No tienes contactos agregados</p>
                                <p className="text-sm text-gray-500">Busca usuarios por su número de teléfono</p>
                            </div>
                        ) : (
                            contacts.map(contact => (
                                <div key={contact.id} className="bg-white border border-gray-200 p-3 rounded-lg">
                                    <div className="flex items-center space-x-3">
                                        <div className="w-10 h-10 bg-black rounded-full flex items-center justify-center text-white font-bold">
                                            {contact.displayName?.charAt(0) || 'U'}
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="font-medium">{contact.displayName}</h4>
                                            <p className="text-sm text-gray-600">@{contact.username}</p>
                                            <p className="text-xs text-gray-500">{contact.userType === 'driver' ? 'Conductor' : 'Usuario'}</p>
                                        </div>
                                        <div className="flex items-center space-x-1">
                                            {contact.isVisible ? (
                                                <Eye size={16} className="text-green-600" />
                                            ) : (
                                                <EyeOff size={16} className="text-red-600" />
                                            )}
                                            <span className="text-xs text-gray-500">
                                                {contact.isVisible ? 'Visible' : 'Oculto'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // Página de mensajes
        const MessagesPage = ({ user }) => (
            <div className="space-y-4">
                <h2 className="text-2xl font-bold text-gray-900">Mensajes</h2>
                <div className="bg-gray-50 p-4 rounded-lg text-center">
                    <MessageSquare size={48} className="mx-auto text-gray-400 mb-2" />
                    <p className="text-gray-600">Sistema de mensajería instantánea</p>
                    <p className="text-sm text-gray-500">Mantente en contacto todo el tiempo</p>
                </div>
            </div>
        );

        // Página de perfil
        const ProfilePage = ({ user, editingProfile, setEditingProfile }) => {
            const [profileData, setProfileData] = useState({
                displayName: user?.displayName || '',
                username: user?.username || '',
                phone: user?.phone || '',
                userType: user?.userType || 'user'
            });
            const [loading, setLoading] = useState(false);

            const saveProfile = async () => {
                setLoading(true);
                try {
                    await db.collection('users').doc(user.id).update({
                        ...profileData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Actualizar perfil de Auth si cambió el nombre
                    if (profileData.displayName !== user.displayName) {
                        await auth.currentUser.updateProfile({ 
                            displayName: profileData.displayName 
                        });
                    }
                    
                    setEditingProfile(false);
                    alert('Perfil actualizado correctamente');
                } catch (error) {
                    console.error('Error actualizando perfil:', error);
                    alert('Error al actualizar el perfil');
                }
                setLoading(false);
            };

            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-gray-900">Perfil</h2>
                        <button
                            onClick={() => setEditingProfile(!editingProfile)}
                            className="flex items-center space-x-2 px-3 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors"
                        >
                            <Edit size={16} />
                            <span>{editingProfile ? 'Cancelar' : 'Editar'}</span>
                        </button>
                    </div>

                    <div className="bg-white border border-gray-200 p-4 rounded-lg">
                        <div className="flex items-center space-x-4 mb-4">
                            <div className="w-16 h-16 bg-black rounded-full flex items-center justify-center text-white font-bold text-xl">
                                {(editingProfile ? profileData.displayName : user?.displayName)?.charAt(0) || 'U'}
                            </div>
                            <div className="flex-1">
                                {editingProfile ? (
                                    <div className="space-y-3">
                                        <input
                                            type="text"
                                            value={profileData.displayName}
                                            onChange={(e) => setProfileData({...profileData, displayName: e.target.value})}
                                            placeholder="Nombre completo"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                                        />
                                        <input
                                            type="text"
                                            value={profileData.username}
                                            onChange={(e) => setProfileData({...profileData, username: e.target.value})}
                                            placeholder="@usuario"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                                        />
                                        <input
                                            type="tel"
                                            value={profileData.phone}
                                            onChange={(e) => setProfileData({...profileData, phone: e.target.value})}
                                            placeholder="Teléfono"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black"
                                        />
                                    </div>
                                ) : (
                                    <div>
                                        <h3 className="font-semibold text-lg">{user?.displayName || 'Usuario'}</h3>
                                        <p className="text-sm text-gray-600">@{user?.username || 'usuario'}</p>
                                        <p className="text-sm text-gray-600">{user?.phone || 'Sin teléfono'}</p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {user?.userType === 'driver' ? '🚗 Conductor' : '👤 Usuario'}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {editingProfile && (
                            <div className="flex space-x-2">
                                <button
                                    onClick={saveProfile}
                                    disabled={loading}
                                    className="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50"
                                >
                                    {loading ? 'Guardando...' : 'Guardar Cambios'}
                                </button>
                                <button
                                    onClick={() => setEditingProfile(false)}
                                    className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                                >
                                    Cancelar
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="bg-gray-50 p-4 rounded-lg">
                        <h4 className="font-semibold text-gray-900 mb-2">Información de Cuenta</h4>
                        <p className="text-sm text-gray-600">
                            <strong>Email:</strong> {user?.email}
                        </p>
                        <p className="text-sm text-gray-600">
                            <strong>ID:</strong> {user?.id}
                        </p>
                        <p className="text-sm text-gray-600">
                            <strong>Tipo:</strong> {user?.userType === 'driver' ? 'Conductor' : 'Usuario'}
                        </p>
                    </div>
                </div>
            );
        };

        // Render de la aplicación
        ReactDOM.render(<UrbanDriveApp />, document.getElementById('root'));
    </script>
</body>
</html>